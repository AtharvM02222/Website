<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸ”’ Secret Chat Room</title>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <style>
    /* Container */
    body { margin:0; font-family: sans-serif; display:flex; flex-direction:column; height:100vh; }
    header { background:#075E54; color:#fff; padding:1rem; display:flex; align-items:center; }
    header h1 { margin:0; font-size:1.2rem; flex:1; }
    #logoutBtn { background:transparent; border:none; color:#fff; cursor:pointer; }
    #chat { flex:1; overflow-y:auto; padding:1rem; background:#ECE5DD; }
    .bubble { max-width:70%; margin-bottom:.5rem; padding:.6rem 1rem; border-radius:1rem; position:relative; display:inline-block; word-wrap:break-word; }
    .bubble.self { background:#DCF8C6; align-self:flex-end; border-bottom-right-radius:0; }
    .bubble.other { background:#FFF; align-self:flex-start; border-bottom-left-radius:0; }
    .timestamp { font-size:.7rem; color:#999; position:absolute; bottom:.2rem; right:.6rem; }
    #inputBar { display:flex; padding:.5rem; background:#fff; }
    #messageInput { flex:1; padding:.8rem; border:1px solid #ccc; border-radius:1.2rem; margin-right:.5rem; }
    #sendBtn { background:#128C7E; border:none; color:#fff; padding:.8rem 1rem; border-radius:50%; cursor:pointer; }
    #typing { font-size:.8rem; color:#666; padding-left:1rem; height:1rem; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”’ Secret Chat</h1>
    <button id="logoutBtn">Logout</button>
  </header>
  <div id="chat"></div>
  <div id="typing"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message" autocomplete="off" />
    <button id="sendBtn">&#9658;</button>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDW9a-Dd4c44QRsjUSpNcjvn1RPzOorXw4",
      authDomain: "protean-tooling-444907-k3.firebaseapp.com",
      projectId: "protean-tooling-444907-k3",
      storageBucket: "protean-tooling-444907-k3.firebasestorage.app",
      messagingSenderId: "989275453863",
      appId: "1:989275453863:web:f04a2937a7785c75231e82",
      measurementId: "G-6ZE618L262"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Crypto parameters
    const enc = new TextEncoder(), dec = new TextDecoder();
    let cryptoKey;
    async function deriveKey(passphrase) {
      const salt = enc.encode('netlify-secret');
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(passphrase), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:100000, hash:'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }
    async function encrypt(text) {
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, cryptoKey, enc.encode(text));
      return { iv: Array.from(iv), ct: Array.from(new Uint8Array(ct)) };
    }
    async function decrypt({ iv, ct }) {
      const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv:new Uint8Array(iv) }, cryptoKey, new Uint8Array(ct));
      return dec.decode(plain);
    }

    // UI Elements
    const chatEl = document.getElementById('chat'), inputEl = document.getElementById('messageInput'), sendBtn = document.getElementById('sendBtn');
    const logoutBtn = document.getElementById('logoutBtn'), typingEl = document.getElementById('typing');

    // Authentication
    netlifyIdentity.on('init', async user => initChat(user));
    netlifyIdentity.on('login', async user => initChat(user));
    netlifyIdentity.on('logout', () => location.reload());
    netlifyIdentity.init();

    async function initChat(user) {
      if (!user) return;
      // Derive crypto key from email (or other secret)
      cryptoKey = await deriveKey(user.email);
      user.jwt().then(token => auth.signInWithCustomToken(token));
      auth.onAuthStateChanged(u => { if (u) startListening(); });
      logoutBtn.onclick = () => netlifyIdentity.logout();
    }

    // Listen for messages
    function startListening() {
      db.collection('secret-chat').orderBy('ts').limit(100)
        .onSnapshot(snap => {
          chatEl.innerHTML = '';
          snap.forEach(doc => renderMessage(doc.id, doc.data()));
          chatEl.scrollTop = chatEl.scrollHeight;
        });
      sendBtn.onclick = sendMessage;
      inputEl.addEventListener('keydown', e => { if (e.key==='Enter') sendMessage(); });
    }

    // Render message bubble
    async function renderMessage(id, data) {
      try {
        const plaintext = await decrypt(data.content);
        const bubble = document.createElement('div'); bubble.className = 'bubble '+(data.user===auth.currentUser.email?'self':'other');
        bubble.textContent = plaintext;
        const ts = new Date(data.ts);
        const stamp = document.createElement('span'); stamp.className='timestamp'; stamp.textContent = ts.toLocaleTimeString();
        bubble.appendChild(stamp);
        chatEl.appendChild(bubble);
      } catch { console.warn('Decryption failed for', id); }
    }

    // Send message
    async function sendMessage() {
      const text = inputEl.value.trim(); if (!text) return;
      sendBtn.disabled = true;
      const payload = await encrypt(text);
      await db.collection('secret-chat').add({ content: payload, ts: Date.now(), user: auth.currentUser.email });
      inputEl.value=''; sendBtn.disabled=false; inputEl.focus();
    }
  </script>
</body>
</html>
