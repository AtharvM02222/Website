<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cloud Notes Chat</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ece5dd;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      position: relative;
      max-width: 70%;
      word-wrap: break-word;
    }
    .own-message {
      background: #dcf8c6;
      margin-left: auto;
    }
    .meta {
      font-size: 12px;
      color: #555;
      margin-bottom: 5px;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: #f0f0f0;
      border-top: 1px solid #ccc;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 20px;
      margin-right: 10px;
    }
    button {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      background: #128c7e;
      color: white;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 5px;
    }
    .actions button {
      width: auto;
      height: auto;
      border-radius: 4px;
      background: #25d366;
      font-size: 10px;
      padding: 3px 6px;
      margin-left: 5px;
    }
    #onlineUsers {
      padding: 10px;
      background: #128c7e;
      color: white;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #typingIndicator {
      font-size: 12px;
      color: #888;
      display: none;
      margin: 5px 10px;
    }
    #photoInput {
      margin-left: 10px;
    }
  </style>
</head>
<body style="display:none;">

  <div id="onlineUsers">
    <span>Online Users: </span>
    <span id="usersList">Loading...</span>
  </div>

  <div id="typingIndicator">
    <span id="typingUser">User</span> is typing...
  </div>

  <div id="chat"></div>

  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Type a note…">
    <input type="file" id="photoInput" accept="image/*">
    <button id="sendButton">➤</button>
    <button id="logoutButton" title="Logout">⎋</button>
  </div>

  <!-- Firebase + Netlify Identity -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    netlifyIdentity.init();

    netlifyIdentity.on('init', user => {
      if (!user) {
        window.location.replace('/main.html');
      } else {
        document.body.style.display = 'flex';
        loadNotes(user);
        updateOnlineUsers();
      }
    });
    netlifyIdentity.on('login', () => location.reload());
    netlifyIdentity.on('logout', () => window.location.replace('/main.html'));

    const firebaseConfig = {
      apiKey: "AIzaSyDW9a-Dd4c44QRsjUSpNcjvn1RPzOorXw4",
      authDomain: "protean-tooling-444907-k3.firebaseapp.com",
      projectId: "protean-tooling-444907-k3",
      storageBucket: "protean-tooling-444907-k3.appspot.com",
      messagingSenderId: "989275453863",
      appId: "1:989275453863:web:f04a2937a7785c75231e82",
      measurementId: "G-6ZE618L262"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const notesRef = db.collection('notes');

    const chatDiv = document.getElementById('chat');
    const messageInput = document.getElementById('messageInput');
    const photoInput = document.getElementById('photoInput');
    const sendButton = document.getElementById('sendButton');
    const logoutButton = document.getElementById('logoutButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingUser = document.getElementById('typingUser');
    const usersList = document.getElementById('usersList');

    let typingTimeout;
    let onlineUsers = {};

    sendButton.addEventListener('click', async () => {
      const user = netlifyIdentity.currentUser();
      const username = user.user_metadata.username
                      || user.user_metadata.full_name
                      || user.email.split('@')[0];

      const text = messageInput.value.trim();
      const file = photoInput.files[0];

      if (!text && !file) return;

      if (file) {
        const storageRef = storage.ref(`photos/${user.id}/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', null, (error) => {
          console.error('Upload failed:', error);
          alert('Failed to upload photo.');
        }, async () => {
          const downloadURL = await storageRef.getDownloadURL();
          await notesRef.add({
            userId: user.id,
            username: username,
            email: user.email,
            photoUrl: downloadURL,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          photoInput.value = '';
        });
      }

      if (text) {
        await notesRef.add({
          userId: user.id,
          username: username,
          email: user.email,
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = '';
      }
    });

    messageInput.addEventListener('input', () => {
      clearTimeout(typingTimeout);
      typingIndicator.style.display = 'block';
      typingUser.innerText = netlifyIdentity.currentUser().user_metadata.username || 'User';
      typingTimeout = setTimeout(() => {
        typingIndicator.style.display = 'none';
      }, 1000);
    });

    logoutButton.addEventListener('click', () => {
      netlifyIdentity.logout();
    });

    function loadNotes(user) {
      notesRef.orderBy('timestamp').onSnapshot(snapshot => {
        chatDiv.innerHTML = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          const isOwn = d.userId === user.id;
          const displayName = d.username || (d.email ? d.email.split('@')[0] : 'Anonymous');
          const msg = document.createElement('div');
          msg.className = 'message' + (isOwn ? ' own-message' : '');
          msg.innerHTML = `
            <div class="meta">
              <strong>${displayName}</strong> • ${formatTimestamp(d.timestamp)}
            </div>
            <div>
              ${d.text ? linkify(d.text) : ''}
              ${d.photoUrl ? `<div><img src="${d.photoUrl}" style="max-width:200px; max-height:200px; border-radius:8px; margin-top:5px;"></div>` : ''}
            </div>
            ${isOwn
              ? `<div class="actions">
                  <button data-id="${doc.id}" data-text="${encodeURIComponent(d.text || '')}">Edit</button>
                  <button data-id="${doc.id}">Delete</button>
                 </div>`
              : ''}
          `;
          chatDiv.appendChild(msg);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        attachActions();
      });
    }

    function attachActions() {
      document.querySelectorAll('.actions button').forEach(btn => {
        const id = btn.getAttribute('data-id');
        if (btn.innerText === 'Edit') {
          const oldText = decodeURIComponent(btn.getAttribute('data-text'));
          btn.onclick = async () => {
            const newText = prompt('Edit your note:', oldText);
            if (newText !== null) {
              await notesRef.doc(id).update({ text: newText });
            }
          };
        } else {
          btn.onclick = async () => {
            if (confirm('Delete this note?')) {
              await notesRef.doc(id).delete();
            }
          };
        }
      });
    }

    function updateOnlineUsers() {
      const users = Object.values(onlineUsers);
      usersList.innerText = users.join(', ') || 'No one';
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      const d = ts.toDate(), now = new Date();
      const isToday = d.toDateString() === now.toDateString();
      const isYesterday = d.toDateString() === new Date(now - 86400000).toDateString();
      const hh = d.getHours(), mm = String(d.getMinutes()).padStart(2, '0');
      return isToday
        ? `Today ${hh}:${mm}`
        : isYesterday
          ? `Yesterday ${hh}:${mm}`
          : `${d.toLocaleDateString()} ${hh}:${mm}`;
    }

    function linkify(text) {
      return text.replace(
        /(https?:\/\/[^\s]+)/g,
        url => `<a href="${url}" target="_blank">${url}</a>`
      );
    }

    netlifyIdentity.on('login', user => {
      onlineUsers[user.id] = user.user_metadata.username || user.email;
      updateOnlineUsers();
    });
    netlifyIdentity.on('logout', () => {
      delete onlineUsers[netlifyIdentity.currentUser().id];
      updateOnlineUsers();
    });
  </script>
</body>
</html>
