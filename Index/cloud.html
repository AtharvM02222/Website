<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ece5dd;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .message {
            background-color: #fff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            position: relative;
            max-width: 70%;
        }
        .own-message {
            background-color: #dcf8c6;
            margin-left: auto;
        }
        .meta {
            font-size: 12px;
            color: #555;
            margin-bottom: 5px;
        }
        #inputArea {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f0f0f0;
        }
        #messageInput {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            margin-right: 10px;
        }
        #sendButton, #fileInput, #logoutButton {
            background-color: #128c7e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 5px;
        }
        img.uploaded {
            max-width: 200px;
            margin-top: 5px;
            border-radius: 8px;
        }
        .actions button {
            margin-left: 5px;
            background-color: #25d366;
            border: none;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div id="chat"></div>

    <div id="inputArea">
        <input type="text" id="messageInput" placeholder="Type a message">
        <input type="file" id="fileInput" style="display:none;">
        <button id="fileButton">+</button>
        <button id="sendButton">→</button>
        <button id="logoutButton">⎋</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDW9a-Dd4c44QRsjUSpNcjvn1RPzOorXw4",
            authDomain: "protean-tooling-444907-k3.firebaseapp.com",
            projectId: "protean-tooling-444907-k3",
            storageBucket: "protean-tooling-444907-k3.appspot.com",
            messagingSenderId: "989275453863",
            appId: "1:989275453863:web:f04a2937a7785c75231e82",
            measurementId: "G-6ZE618L262"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const messagesRef = db.collection('messages');

        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const logoutButton = document.getElementById('logoutButton');
        const fileInput = document.getElementById('fileInput');
        const fileButton = document.getElementById('fileButton');

        netlifyIdentity.init();

        netlifyIdentity.on('login', user => {
            loadMessages(user);
        });

        logoutButton.addEventListener('click', () => {
            netlifyIdentity.logout();
            location.reload();
        });

        fileButton.addEventListener('click', () => {
            fileInput.click();
        });

        sendButton.addEventListener('click', async () => {
            const user = netlifyIdentity.currentUser();
            const text = messageInput.value.trim();
            const file = fileInput.files[0];
            let fileUrl = null;

            if (!text && !file) return;

            const username = user.user_metadata.username || user.user_metadata.full_name || user.email.split('@')[0];
            const userId = user.id;
            const email = user.email;

            if (file) {
                alert('File upload feature needs Firebase Storage setup.');
                return;
            }

            await messagesRef.add({
                userId: userId,
                username: username,
                email: email,
                text: text,
                fileUrl: fileUrl,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            messageInput.value = '';
            fileInput.value = '';
        });

        function loadMessages(user) {
            messagesRef.orderBy('timestamp').onSnapshot(snapshot => {
                chatDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const messageDiv = document.createElement('div');
                    const isOwn = data.userId === user.id;
                    const displayName = data.username || (data.email ? data.email.split('@')[0] : 'Anonymous');

                    messageDiv.className = 'message' + (isOwn ? ' own-message' : '');
                    messageDiv.innerHTML = `
                        <div class="meta"><strong>${displayName}</strong> • ${formatTimestamp(data.timestamp)}</div>
                        <div>${linkify(data.text)}</div>
                        ${data.fileUrl ? `<img src="${data.fileUrl}" class="uploaded">` : ''}
                        ${isOwn ? `<div class="actions">
                            <button onclick="editMessage('${doc.id}', '${data.text}')">Edit</button>
                            <button onclick="deleteMessage('${doc.id}')">Delete</button>
                        </div>` : ''}
                    `;
                    chatDiv.appendChild(messageDiv);
                });
                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const isYesterday = date.toDateString() === new Date(now - 86400000).toDateString();

            if (isToday) return `Today ${date.getHours()}:${pad(date.getMinutes())}`;
            if (isYesterday) return `Yesterday ${date.getHours()}:${pad(date.getMinutes())}`;
            return `${date.toDateString()} ${date.getHours()}:${pad(date.getMinutes())}`;
        }

        function pad(num) {
            return num < 10 ? '0' + num : num;
        }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
        }

        async function editMessage(id, oldText) {
            const newText = prompt('Edit your message:', oldText);
            if (newText !== null) {
                await messagesRef.doc(id).update({ text: newText });
            }
        }

        async function deleteMessage(id) {
            if (confirm('Are you sure you want to delete this message?')) {
                await messagesRef.doc(id).delete();
            }
        }
    </script>
</body>
</html>
