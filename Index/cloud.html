<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloud Notes</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; padding: 20px; }
        #notes { margin-top: 20px; }
        .note { background: #fff; padding: 10px; margin: 10px 0; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button { margin-left: 5px; }
    </style>
</head>
<body>
    <h1>Cloud Notes</h1>
    <button onclick="netlifyIdentity.logout()">Logout</button>
    <br><br>
    <input type="text" id="newNote" placeholder="Write a note...">
    <button onclick="addNote()">Add Note</button>

    <div id="notes"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
        // Initialize Netlify Identity
        netlifyIdentity.init();

        let currentUserEmail = '';

        netlifyIdentity.on('init', user => {
            if (!user) {
                window.location.href = "/main.html";
            } else {
                currentUserEmail = user.email;
                displayNotes();
            }
        });

        netlifyIdentity.on('login', () => document.location.reload());
        netlifyIdentity.on('logout', () => window.location.href = "/main.html");

        // Firebase config (replace with your actual project values)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const notesRef = db.collection('notes');

        function displayNotes() {
            notesRef.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                const notesDiv = document.getElementById('notes');
                notesDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const note = doc.data();
                    const isOwner = note.user === currentUserEmail;
                    notesDiv.innerHTML += `
                        <div class="note">
                            <strong>${note.user}:</strong> ${note.text}
                            ${isOwner ? `
                                <button onclick="editNote('${doc.id}', '${note.text.replace(/'/g, "\\'")}')">Edit</button>
                                <button onclick="deleteNote('${doc.id}')">Delete</button>
                            ` : ''}
                        </div>
                    `;
                });
            });
        }

        function addNote() {
            const newNote = document.getElementById('newNote').value.trim();
            if (newNote) {
                notesRef.add({
                    text: newNote,
                    user: currentUserEmail,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('newNote').value = '';
            }
        }

        function editNote(id, oldText) {
            const updatedNote = prompt('Edit your note:', oldText);
            if (updatedNote !== null && updatedNote.trim() !== '') {
                notesRef.doc(id).get().then(doc => {
                    if (doc.exists && doc.data().user === currentUserEmail) {
                        notesRef.doc(id).update({ text: updatedNote.trim() });
                    } else {
                        alert('You can only edit your own notes.');
                    }
                });
            }
        }

        function deleteNote(id) {
            notesRef.doc(id).get().then(doc => {
                if (doc.exists && doc.data().user === currentUserEmail) {
                    notesRef.doc(id).delete();
                } else {
                    alert('You can only delete your own notes.');
                }
            });
        }
    </script>
</body>
</html>
